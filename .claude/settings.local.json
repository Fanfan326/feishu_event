{
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(python3:*)",
      "Bash(pip3 install:*)",
      "Bash(expect -c '\nspawn ssh -o StrictHostKeyChecking=no root@192.168.72.104\nexpect {\n    \"\"password:\"\" {\n        send \"\"ppio.123\\\\r\"\"\n        exp_continue\n    }\n    \"\"# \"\" {\n        send \"\"mysql -h 10.1.162.13 -u nexus_ro -pXagCdnqvUnE2wwwe nexus -e \\\\\"\"SHOW COLUMNS FROM nexus_nodes_v2\\\\\"\" 2>/dev/null\\\\r\"\"\n        expect \"\"# \"\"\n        send \"\"exit\\\\r\"\"\n    }\n}\nexpect eof\n')",
      "Bash(expect -c '\nspawn ssh -o StrictHostKeyChecking=no root@192.168.72.104\nexpect \"\"password:\"\"\nsend \"\"ppio123\\\\r\"\"\nexpect \"\"# \"\"\nsend \"\"cat > /data/gpu_inventory.py << ''''ENDOFFILE''''\n\\\\\"\"\\\\\"\"\\\\\"\"\nGPU 库存查询模块\n从 MySQL 数据库查询 Grafana 显示的 GPU 库存数据\n\\\\\"\"\\\\\"\"\\\\\"\"\n\nimport pymysql\nfrom typing import Optional, Dict, List, Tuple\n\n# 数据库配置\nDB_CONFIG = {\n    \\\\\"\"host\\\\\"\": \\\\\"\"10.1.162.13\\\\\"\",\n    \\\\\"\"port\\\\\"\": 3306,\n    \\\\\"\"user\\\\\"\": \\\\\"\"nexus_ro\\\\\"\",\n    \\\\\"\"password\\\\\"\": \\\\\"\"XagCdnqvUnE2wwwe\\\\\"\",\n    \\\\\"\"database\\\\\"\": \\\\\"\"nexus\\\\\"\"\n}\n\n# 海外机房关键词\nOVERSEAS_IDC_KEYWORDS = [\\\\\"\"dallas\\\\\"\", \\\\\"\"canopy\\\\\"\", \\\\\"\"gcore\\\\\"\"]\n\n# 高主频机房关键词（供应商为 bingte）\nHIGH_FREQ_IDC_KEYWORDS = [\\\\\"\"bingte\\\\\"\"]\n\n# GPU 类型映射\nGPU_TYPE_MAP = {\n    \\\\\"\"5090\\\\\"\": \\\\\"\"NVIDIA GeForce RTX 5090\\\\\"\",\n    \\\\\"\"4090\\\\\"\": \\\\\"\"NVIDIA GeForce RTX 4090\\\\\"\",\n    \\\\\"\"3090\\\\\"\": \\\\\"\"NVIDIA GeForce RTX 3090\\\\\"\",\n    \\\\\"\"H100\\\\\"\": \\\\\"\"NVIDIA H100 80GB HBM3\\\\\"\",\n    \\\\\"\"H20\\\\\"\": \\\\\"\"NVIDIA H20\\\\\"\",\n    \\\\\"\"H200\\\\\"\": \\\\\"\"NVIDIA H200\\\\\"\",\n    \\\\\"\"A100\\\\\"\": \\\\\"\"NVIDIA A100-SXM4-80GB\\\\\"\",\n    \\\\\"\"L40S\\\\\"\": \\\\\"\"NVIDIA L40S\\\\\"\",\n    \\\\\"\"5880\\\\\"\": \\\\\"\"NVIDIA RTX 5880 Ada Generation\\\\\"\",\n    \\\\\"\"6000\\\\\"\": \\\\\"\"NVIDIA RTX 6000 Ada Generation\\\\\"\",\n}\n\n\ndef get_db_connection\\(\\):\n    return pymysql.connect\\(**DB_CONFIG\\)\n\n\ndef is_overseas_idc\\(idc: str\\) -> bool:\n    if not idc:\n        return False\n    idc_lower = idc.lower\\(\\)\n    return any\\(keyword in idc_lower for keyword in OVERSEAS_IDC_KEYWORDS\\)\n\n\ndef is_high_freq_idc\\(idc: str\\) -> bool:\n    if not idc:\n        return False\n    idc_lower = idc.lower\\(\\)\n    return any\\(keyword in idc_lower for keyword in HIGH_FREQ_IDC_KEYWORDS\\)\n\n\ndef get_all_gpu_inventory\\(region: str = None, high_freq: bool = None\\) -> List[Dict]:\n    conn = get_db_connection\\(\\)\n    cursor = conn.cursor\\(\\)\n    cursor.execute\\(''''''''\n        SELECT gpu_product_name, idc, SUM\\(total_gpu_num\\) as total,\n               SUM\\(free_gpu_num\\) as free, SUM\\(used_gpu_num\\) as used,\n               SUM\\(unavailable_gpu_num\\) as unavailable\n        FROM nexus_nodes_v2\n        WHERE deleted_time = 0 AND gpu_product_name != ''''''''\n        GROUP BY gpu_product_name, idc\n    ''''''''\\)\n    gpu_data = {}\n    for row in cursor.fetchall\\(\\):\n        gpu_name, idc = row[0], row[1] or \\\\\"\"\\\\\"\"\n        total, free, used, unavailable = row[2] or 0, row[3] or 0, row[4] or 0, row[5] or 0\n        is_overseas = is_overseas_idc\\(idc\\)\n        if region == \\\\\"\"海外\\\\\"\" and not is_overseas:\n            continue\n        if region == \\\\\"\"国内\\\\\"\" and is_overseas:\n            continue\n        is_high = is_high_freq_idc\\(idc\\)\n        if high_freq is True and not is_high:\n            continue\n        if high_freq is False and is_high:\n            continue\n        key = \\(gpu_name, is_high\\)\n        if key not in gpu_data:\n            gpu_data[key] = {\\\\\"\"total\\\\\"\": 0, \\\\\"\"free\\\\\"\": 0, \\\\\"\"used\\\\\"\": 0, \\\\\"\"unavailable\\\\\"\": 0}\n        gpu_data[key][\\\\\"\"total\\\\\"\"] += total\n        gpu_data[key][\\\\\"\"free\\\\\"\"] += free\n        gpu_data[key][\\\\\"\"used\\\\\"\"] += used\n        gpu_data[key][\\\\\"\"unavailable\\\\\"\"] += unavailable\n    conn.close\\(\\)\n    result = []\n    for \\(gpu_name, is_high\\), data in gpu_data.items\\(\\):\n        result.append\\({\\\\\"\"name\\\\\"\": gpu_name, \\\\\"\"is_high_freq\\\\\"\": is_high, **data}\\)\n    result.sort\\(key=lambda x: x[\\\\\"\"total\\\\\"\"], reverse=True\\)\n    return result\n\n\ndef get_gpu_inventory_by_type\\(gpu_type: str, region: str = None, high_freq: bool = None\\) -> Optional[Dict]:\n    gpu_type_upper = gpu_type.upper\\(\\)\n    db_gpu_name = GPU_TYPE_MAP.get\\(gpu_type_upper\\)\n    conn = get_db_connection\\(\\)\n    cursor = conn.cursor\\(\\)\n    if db_gpu_name:\n        cursor.execute\\(''''''''\n            SELECT gpu_product_name, idc, SUM\\(total_gpu_num\\) as total,\n                   SUM\\(free_gpu_num\\) as free, SUM\\(used_gpu_num\\) as used,\n                   SUM\\(unavailable_gpu_num\\) as unavailable\n            FROM nexus_nodes_v2\n            WHERE deleted_time = 0 AND gpu_product_name = %s\n            GROUP BY gpu_product_name, idc\n        '''''''', \\(db_gpu_name,\\)\\)\n    else:\n        cursor.execute\\(''''''''\n            SELECT gpu_product_name, idc, SUM\\(total_gpu_num\\) as total,\n                   SUM\\(free_gpu_num\\) as free, SUM\\(used_gpu_num\\) as used,\n                   SUM\\(unavailable_gpu_num\\) as unavailable\n            FROM nexus_nodes_v2\n            WHERE deleted_time = 0 AND gpu_product_name LIKE %s\n            GROUP BY gpu_product_name, idc\n        '''''''', \\(f''''%{gpu_type}%'''',\\)\\)\n    result = {\\\\\"\"total\\\\\"\": 0, \\\\\"\"free\\\\\"\": 0, \\\\\"\"used\\\\\"\": 0, \\\\\"\"unavailable\\\\\"\": 0, \\\\\"\"name\\\\\"\": None}\n    for row in cursor.fetchall\\(\\):\n        gpu_name, idc = row[0], row[1] or \\\\\"\"\\\\\"\"\n        total, free, used, unavailable = row[2] or 0, row[3] or 0, row[4] or 0, row[5] or 0\n        is_overseas = is_overseas_idc\\(idc\\)\n        if region == \\\\\"\"海外\\\\\"\" and not is_overseas:\n            continue\n        if region == \\\\\"\"国内\\\\\"\" and is_overseas:\n            continue\n        is_high = is_high_freq_idc\\(idc\\)\n        if high_freq is True and not is_high:\n            continue\n        if high_freq is False and is_high:\n            continue\n        result[\\\\\"\"name\\\\\"\"] = gpu_name\n        result[\\\\\"\"total\\\\\"\"] += total\n        result[\\\\\"\"free\\\\\"\"] += free\n        result[\\\\\"\"used\\\\\"\"] += used\n        result[\\\\\"\"unavailable\\\\\"\"] += unavailable\n    conn.close\\(\\)\n    if result[\\\\\"\"name\\\\\"\"]:\n        result[\\\\\"\"is_high_freq\\\\\"\"] = high_freq if high_freq is not None else False\n        return result\n    return None\n\n\ndef format_inventory_message\\(inventory: List[Dict]\\) -> str:\n    if not inventory:\n        return \\\\\"\"暂无库存数据\\\\\"\"\n    lines = [\\\\\"\"GPU 库存汇总\\\\\\\\n\\\\\"\"]\n    for item in inventory:\n        name = item[\\\\\"\"name\\\\\"\"]\n        for short, full in GPU_TYPE_MAP.items\\(\\):\n            if full == name:\n                name = short\n                break\n        if item.get\\(\\\\\"\"is_high_freq\\\\\"\"\\):\n            name = f\\\\\"\"高主频{name}\\\\\"\"\n        lines.append\\(f\\\\\"\"{name}\\\\\"\"\\)\n        lines.append\\(f\\\\\"\"   总数: {item[''''total'''']} | 空闲: {item[''''free'''']} | 使用中: {item[''''used'''']}\\\\\"\"\\)\n        lines.append\\(\\\\\"\"\\\\\"\"\\)\n    return \\\\\"\"\\\\\\\\n\\\\\"\".join\\(lines\\)\n\n\ndef format_single_gpu_message\\(gpu_info: Dict, high_freq: bool = None\\) -> str:\n    if not gpu_info:\n        return \\\\\"\"未找到该 GPU 类型的库存信息\\\\\"\"\n    name = gpu_info[\\\\\"\"name\\\\\"\"]\n    for short, full in GPU_TYPE_MAP.items\\(\\):\n        if full == name:\n            name = short\n            break\n    if high_freq is True or gpu_info.get\\(\\\\\"\"is_high_freq\\\\\"\"\\):\n        name = f\\\\\"\"高主频{name}\\\\\"\"\n    return f\\\\\"\"\\\\\"\"\\\\\"\"{name} 库存\n\n总数: {gpu_info[''''total'''']} 卡\n空闲: {gpu_info[''''free'''']} 卡\n使用中: {gpu_info[''''used'''']} 卡\n不可用: {gpu_info[''''unavailable'''']} 卡\\\\\"\"\\\\\"\"\\\\\"\"\n\n\ndef parse_user_question\\(text: str\\) -> Tuple[Optional[str], Optional[str], Optional[bool]]:\n    text_upper = text.upper\\(\\)\n    text_lower = text.lower\\(\\)\n    gpu_type = None\n    for short_name in GPU_TYPE_MAP.keys\\(\\):\n        if short_name in text_upper:\n            gpu_type = short_name\n            break\n    region = None\n    if \\\\\"\"国内\\\\\"\" in text or \\\\\"\"中国\\\\\"\" in text:\n        region = \\\\\"\"国内\\\\\"\"\n    elif \\\\\"\"海外\\\\\"\" in text or \\\\\"\"国外\\\\\"\" in text:\n        region = \\\\\"\"海外\\\\\"\"\n    high_freq = None\n    if \\\\\"\"高主频\\\\\"\" in text or \\\\\"\"bingte\\\\\"\" in text_lower:\n        high_freq = True\n    elif \\\\\"\"普通\\\\\"\" in text or \\\\\"\"非高主频\\\\\"\" in text:\n        high_freq = False\n    return gpu_type, region, high_freq\n\n\nasync def get_gpu_availability\\(gpu_type: str, region: str = None, high_freq: bool = None\\) -> Optional[int]:\n    gpu_info = get_gpu_inventory_by_type\\(gpu_type, region=region, high_freq=high_freq\\)\n    if gpu_info:\n        return gpu_info[\\\\\"\"free\\\\\"\"]\n    return None\nENDOFFILE\\\\r\"\"\nexpect \"\"# \"\"\nsend \"\"echo done\\\\r\"\"\nexpect \"\"# \"\"\nsend \"\"exit\\\\r\"\"\nexpect eof\n')",
      "Bash(expect:*)",
      "Bash(curl -s -X POST \"https://api.ppinfra.com/v3/openai/chat/completions\" -H \"Authorization: Bearer sk__6-1_QVbH5APf546zf7vlhFWtGmm3ktr1wZZ2T8KHX8\" -H \"Content-Type: application/json\" -d '{\"\"model\"\": \"\"gpt-4o\"\", \"\"messages\"\": [{\"\"role\"\": \"\"user\"\", \"\"content\"\": \"\"hello\"\"}], \"\"max_tokens\"\": 50}')",
      "Bash(curl -s -X POST \"https://api.ppinfra.com/v3/openai/chat/completions\" -H \"Authorization: Bearer sk__6-1_QVbH5APf546zf7vlhFWtGmm3ktr1wZZ2T8KHX8\" -H \"Content-Type: application/json\" -d '{\"\"model\"\": \"\"deepseek/deepseek-v3-turbo\"\", \"\"messages\"\": [{\"\"role\"\": \"\"user\"\", \"\"content\"\": \"\"你好\"\"}], \"\"max_tokens\"\": 50}')",
      "Bash(ssh:*)",
      "Bash(sshpass:*)",
      "Bash(brew install:*)",
      "Bash(curl:*)",
      "Bash(export SSHPASS='ppio123')",
      "Bash(/tmp/check_specific_line.expect)",
      "Bash(/tmp/apply_sed2.expect)",
      "Bash(/tmp/test_syntax.expect)",
      "Bash(/tmp/restart_service.expect)",
      "Bash(/tmp/check_log.expect)",
      "Bash(/tmp/check_recent_log.expect)",
      "Bash(/tmp/apply_fix_price.expect)",
      "Bash(/tmp/check_price_text.expect)",
      "Bash(/tmp/apply_price_python.expect)",
      "Bash(/tmp/apply_correct.expect)",
      "Bash(/tmp/apply_emoji.expect)",
      "Bash(/tmp/check_latest_log.expect)",
      "Bash(/tmp/run_fix_re.expect:*)",
      "Bash(/tmp/check_sent_messages.expect)",
      "Bash(/tmp/check_inventory_py.expect)",
      "Bash(/tmp/check_inventory_format.expect)",
      "Bash(/tmp/apply_inventory_funny.expect)",
      "Bash(/tmp/check_recent_activity.expect)",
      "Bash(/tmp/show_reserve_logic.expect)",
      "Bash(/tmp/find_reserve_keywords.expect)",
      "Bash(/tmp/apply_improve.expect)",
      "Bash(/tmp/show_actual_reply.expect)",
      "Bash(/tmp/check_reply_text.expect)",
      "Bash(/tmp/verify_funny_text.expect)",
      "Bash(/tmp/show_current_texts.expect)",
      "Bash(/tmp/show_line_1287.expect)",
      "Bash(/tmp/apply_line_fix.expect)",
      "Bash(/tmp/apply_1242.expect:*)",
      "Bash(/tmp/check_service_status.expect)",
      "Bash(/tmp/check_error_log.expect)",
      "Bash(/tmp/apply_question_fix.expect)",
      "Bash(/tmp/apply_1242_correct.expect)",
      "Bash(/tmp/apply_1287_correct.expect)",
      "Bash(/tmp/restore_backup.expect)",
      "Bash(/tmp/check_current_format.expect)",
      "Bash(/tmp/apply_simple_funny.expect)",
      "Bash(/tmp/apply_safe_funny.expect)",
      "Bash(/tmp/check_actual_messages.expect)",
      "Bash(/tmp/verify_changes.expect)",
      "Bash(/tmp/apply_complete_fix.expect)",
      "Bash(/tmp/apply_rewrite.expect:*)",
      "Bash(/tmp/check_recent_log_full.expect:*)",
      "Bash(/tmp/apply_re_fix_final.expect)",
      "Bash(/tmp/apply_step1.expect)",
      "Bash(/tmp/apply_step2.expect)",
      "Bash(/tmp/apply_step3.expect)",
      "Bash(/tmp/apply_step4.expect)",
      "Bash(/tmp/apply_thanks_fix.expect)",
      "Bash(/tmp/check_customer_id_extraction.expect)",
      "Bash(/tmp/show_whole_machine_logic.expect)",
      "Bash(/tmp/apply_id_quantity_fix.expect)",
      "Bash(scp:*)",
      "Bash(chmod:*)",
      "Bash(/tmp/test_region_mapping.sh)",
      "Bash(/tmp/diagnose_bot.sh)",
      "Bash(bash:*)",
      "Bash(/tmp/fix_idc_map_error.sh)",
      "Bash(export PPIO_API_KEY=\"sk__6-1_QVbH5APf546zf7vlhFWtGmm3ktr1wZZ2T8KHX8\")",
      "Bash(unset:*)",
      "Bash(grep -r \"password\\\\|api_key\\\\|secret\\\\|token\" *.py)",
      "Bash(grep -n \"APP_ID\\\\|APP_SECRET\\\\|API_KEY\\\\|password\\\\|WEBHOOK_URL\" *.py)",
      "Bash(/usr/bin/python3 -m pip install python-dotenv)",
      "Bash(/usr/bin/python3 -m pip install pymysql)",
      "Bash(git init)",
      "Bash(git remote set-url origin git@github.com:Fanfan326/feishu_event.git)",
      "Bash(ssh-keygen -t ed25519 -C \"your_email@example.com\" -f ~/.ssh/github_new -N \"\")",
      "Bash(git config core.sshCommand \"ssh -i ~/.ssh/github_new -o IdentitiesOnly=yes\")",
      "Bash(grep -r \"glsa_\" *.py)",
      "Bash(git add python3.py)",
      "Bash(git remote add origin git@github.com:Fanfan326/feishu_event.git)",
      "Bash(git push -u origin main --force)",
      "Bash(git config user.name)",
      "Bash(git config user.email)",
      "Bash(git config user.name \"你的 GitHub zhangfan\")",
      "Bash(git config user.email \"564224586@qq.com\")",
      "Bash(git push -f origin main)",
      "Read(//Users/francinapeng/Public/**)",
      "Bash(git add -A)"
    ],
    "additionalDirectories": [
      "/Users/francinapeng/Public/.git"
    ]
  }
}
